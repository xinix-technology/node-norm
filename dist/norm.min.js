!function(t){var e={};function s(i){if(e[i])return e[i].exports;var r=e[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,s),r.l=!0,r.exports}s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)s.d(i,r,function(e){return t[e]}.bind(null,r));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=26)}([function(t,e,s){const i=s(16);t.exports=class{constructor(t){this.name=t,this.filters=[]}filter(...t){return t.forEach(t=>{this.filters.push(i.get(t))}),this}execFilter(t,{session:e,row:s}){"string"==typeof t&&(t=t.trim());let i=this;return this.filters.reduce(async(t,r)=>r(await t,{session:e,row:s,field:i}),t)}attach(t){return t}}},function(t,e){t.exports=class{constructor({name:t}){this.name=t,this._hasTx=!1}async begin(){this._hasTx||(await this._begin(),this._hasTx=!0)}async commit(){this._hasTx&&(await this._commit(),this._hasTx=!1)}async rollback(){this._hasTx&&(await this._rollback(),this._hasTx=!1)}_begin(){}_commit(){}_rollback(){}}},function(t,e,s){const i=s(1),r=s(3);class n extends i{constructor(t){super(t),this.data=t.data||{}}load(t,e=(()=>{})){let s=this.data[t.schema.name]||[],{criteria:i,sorts:r}=t;if(i&&void 0!==i.id){const t=s.find(t=>t.id===i.id);s=t?[t]:[]}else{if(s=s.filter(t=>this._matchCriteria(i,t)),r){let t=Object.keys(r);s=s.sort((e,s)=>{let i=0;return t.forEach((n,o)=>{let a=r[n],c=Math.pow(2,t.length-o-1)*a;e[n]<s[n]?i-=c:e[n]>s[n]&&(i+=c)}),i})}if(t.offset<0)return s;s=t.length<0?s.slice(t.offset):s.slice(t.offset,t.offset+t.length)}return s.map(t=>(e(t),t))}insert(t,e=(()=>{})){const s=this.data[t.schema.name]=this.data[t.schema.name]||[];return t.rows.reduce((t,i)=>(i=Object.assign({id:r()},i),s.push(i),e(i),++t),0)}update(t){let e=Object.keys(t.sets);return this.load(t).reduce((s,i)=>{return e.filter(e=>i[e]!==t.sets[e]&&(i[e]=t.sets[e],!0)).length&&s++,s},0)}drop(t){delete this.data[t.schema.name]}truncate(t){this.data[t.schema.name]=[]}delete(t){const e=this.data[t.schema.name]=this.data[t.schema.name]||[];this.load(t).forEach(t=>{const s=e.indexOf(t);s>=0&&e.splice(s,1)})}async count(t,e){let{length:s,offset:i}=t;e||(t.offset=0,t.length=-1);let r=0;return await this.load(t,()=>r++),t.offset=i,t.length=s,r}_matchCriteria(t,e){if(!t)return!0;for(let s in t){let i=t[s],[r,n="eq"]=s.split("!"),o=e[r];switch(n){case"or":let t=!1;for(let s of i){if(this._matchCriteria(s,e)){t=!0;break}}if(!t)return!1;break;case"and":for(let t of i)if(!this._matchCriteria(t,e))return!1;break;case"eq":if(i!==o)return!1;break;case"ne":if(i===o)return!1;break;case"gt":if(!(o>i))return!1;break;case"gte":if(!(o>=i))return!1;break;case"lt":if(!(o<i))return!1;break;case"lte":if(!(o<=i))return!1;break;case"in":if(-1===i.indexOf(o))return!1;break;case"nin":if(-1!==i.indexOf(o))return!1;break;case"like":let s=new RegExp(i);if(!o.match(s))return!1;break;case"regex":if(!o.match(i))return!1;break;case"where":if(!i(o,e))return!1;break;default:throw new Error(`Operator '${n}' is not implemented yet!`)}}return!0}}if("undefined"!=typeof window){let t=window.norm;if(!t)throw new Error("Norm is not defined yet!");t.adapters=t.adapters||{},t.adapters.Memory=n}t.exports=n},function(t,e,s){var i=s(4),r=s(5);t.exports=function(t,e,s){var n=e&&s||0;"string"==typeof t&&(e="binary"===t?new Array(16):null,t=null);var o=(t=t||{}).random||(t.rng||i)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,e)for(var a=0;a<16;++a)e[n+a]=o[a];return e||r(o)}},function(t,e){var s="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof window.msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto);if(s){var i=new Uint8Array(16);t.exports=function(){return s(i),i}}else{var r=new Array(16);t.exports=function(){for(var t,e=0;e<16;e++)0==(3&e)&&(t=4294967296*Math.random()),r[e]=t>>>((3&e)<<3)&255;return r}}},function(t,e){for(var s=[],i=0;i<256;++i)s[i]=(i+256).toString(16).substr(1);t.exports=function(t,e){var i=e||0,r=s;return[r[t[i++]],r[t[i++]],r[t[i++]],r[t[i++]],"-",r[t[i++]],r[t[i++]],"-",r[t[i++]],r[t[i++]],"-",r[t[i++]],r[t[i++]],"-",r[t[i++]],r[t[i++]],r[t[i++]],r[t[i++]],r[t[i++]],r[t[i++]]].join("")}},function(t,e,s){"use strict";class i{constructor(t){this._state=i.PENDING,this._resolve=void 0,this._reject=void 0,this._promise=new t((t,e)=>{this._resolve=t,this._reject=e})}get state(){return this._state}get promise(){return this._promise}reject(t){this._state===i.PENDING&&(this._state=i.REJECTED,this._reject(t))}resolve(t){this._state===i.PENDING&&(this._state=i.FULFILLED,this._resolve(t))}}i.PENDING="PENDING",i.FULFILLED="FULFILLED",i.REJECTED="REJECTED",t.exports=i},function(t,e,s){"use strict";const i=s(10),r=s(11);t.exports=class{constructor(){this._list=new i}shift(){if(0===this.length)return;const t=this._list.head;return this._list.remove(t),t.data}unshift(t){const e=i.createNode(t);this._list.insertBeginning(e)}push(t){const e=i.createNode(t);this._list.insertEnd(e)}pop(){if(0===this.length)return;const t=this._list.tail;return this._list.remove(t),t.data}[Symbol.iterator](){return new r(this._list)}iterator(){return new r(this._list)}reverseIterator(){return new r(this._list,!0)}get head(){if(0!==this.length)return this._list.head.data}get tail(){if(0!==this.length)return this._list.tail.data}get length(){return this._list.length}}},function(t,e,s){const i=s(28),r=s(13);let n=0;t.exports=class{constructor(t){let{name:e,adapter:r=s(2),schemas:o=[],min:a=1,max:c=1}=t;this.name=e||`pool-${n++}`,this.schemas={},o.forEach(t=>this.putSchema(t));const h=r;Object.defineProperty(this,"_pool",{enumerable:!1,writable:!1,configurable:!1,value:i.createPool({create:()=>new h(t),destroy(){}},{min:a,max:c})})}putSchema({name:t,fields:e,observers:s,modelClass:i}){let n=this.name;return this.schemas[t]=new r({connection:n,name:t,fields:e,observers:s,modelClass:i}),this}getSchema(t){return this.schemas[t]||this.putSchema({name:t}),this.schemas[t]}acquire(...t){return this._pool.acquire(...t)}release(...t){return this._pool.release(...t)}drain(...t){return this._pool.acquire(...t)}clear(...t){return this._pool.clear(...t)}}},function(t,e,s){"use strict";t.exports=class{evict(t,e,s){const i=Date.now()-e.lastIdleTime;return t.softIdleTimeoutMillis<i&&t.min<s||t.idleTimeoutMillis<i}}},function(t,e,s){"use strict";t.exports=class{constructor(){this.head=null,this.tail=null,this.length=0}insertBeginning(t){null===this.head?(this.head=t,this.tail=t,t.prev=null,t.next=null,this.length++):this.insertBefore(this.head,t)}insertEnd(t){null===this.tail?this.insertBeginning(t):this.insertAfter(this.tail,t)}insertAfter(t,e){e.prev=t,e.next=t.next,null===t.next?this.tail=e:t.next.prev=e,t.next=e,this.length++}insertBefore(t,e){e.prev=t.prev,e.next=t,null===t.prev?this.head=e:t.prev.next=e,t.prev=e,this.length++}remove(t){null===t.prev?this.head=t.next:t.prev.next=t.next,null===t.next?this.tail=t.prev:t.next.prev=t.prev,t.prev=null,t.next=null,this.length--}static createNode(t){return{prev:null,next:null,data:t}}}},function(t,e,s){"use strict";const i=s(39);t.exports=class extends i{next(){const t=super.next();return t.value&&(t.value=t.value.data),t}}},function(t,e,s){"use strict";const i=s(40);t.exports=class{constructor(t){this._size=Math.max(0|+t,1),this._slots=[];for(let t=0;t<this._size;t++)this._slots.push(new i)}get length(){let t=0;for(let e=0,s=this._slots.length;e<s;e++)t+=this._slots[e].length;return t}enqueue(t,e){(e=e&&0|+e||0)&&(e<0||e>=this._size)&&(e=this._size-1),this._slots[e].push(t)}dequeue(){for(let t=0,e=this._slots.length;t<e;t+=1)if(this._slots[t].length)return this._slots[t].shift()}get head(){for(let t=0,e=this._slots.length;t<e;t+=1)if(this._slots[t].length>0)return this._slots[t].head}get tail(){for(let t=this._slots.length-1;t>=0;t--)if(this._slots[t].length>0)return this._slots[t].tail}}},function(t,e,s){const i=s(42),r=s(14),n=s(43);t.exports=class{constructor({name:t,fields:e=[],observers:s=[],modelClass:i=r}){if(!t)throw new Error("Schema name is required");this.name=t,this.fields=e,this.observers=s,this.modelClass=i}attach(t={}){let e=this.modelClass;return this.fields.forEach(e=>{void 0===t[e.name]||null===t[e.name]?t[e.name]=null:t[e.name]=e.attach(t[e.name])}),new e(t)}observe(t,e){if(!this._observerRunner){let t=this.observers.map(t=>(e,s)=>"function"!=typeof t[e.query.mode]?s():t[e.query.mode](e,s));this._observerRunner=n(t)}return this._observerRunner(t,e)}async filter(t,{session:e,partial:s=!1}){const r=new i;if(!t)throw r.add(new Error("Cannot filter empty row")),r;if(await Promise.all(this.fields.map(async i=>{try{if(s&&void 0===t[i.name])return;t[i.name]=await i.execFilter(t[i.name],{session:e,row:t})}catch(t){t.field=i,r.add(t)}})),!r.empty())throw r;return t}}},function(t,e){t.exports=class{constructor(t){for(let e in t)t.hasOwnProperty(e)&&void 0!==t[e]&&(this[e]=t[e])}}},function(t,e){t.exports=class{constructor({session:t,schema:e,criteria:s}){this.session=t,[this.connection,this.schema]=this.session.parseSchema(e),this.find(s),this.rows=[],this.sets={},this.length=-1,this.offset=0,this.sorts=void 0}find(t={}){return this.criteria="object"==typeof t?t:{id:t},this}insert(t){return this.mode="insert",this.rows.push(this.schema.attach(t)),this}sort(t){return this.sorts=t,this}limit(t){return this.length=t,this}skip(t){return this.offset=t,this}set(t){return this.mode="update",this.sets=this.schema.attach(t),this}async delete({observer:t=!0}={}){this.mode="delete";let e={query:this};return t?await this.schema.observe(e,t=>this._delete(t)):await this._delete(e),e.result}async _delete(){const t=await this.session.acquire(this.connection);return await t.delete(this)}async save({filter:t=!0,observer:e=!0}={}){let s={query:this,filter:t};return e?await this.schema.observe(s,t=>this._save(t)):await this._save(s),this}async _save(t){const e=await this.session.acquire(this.connection);let{session:s}=this,{filter:i}=t;if(this.rows.length){i&&await Promise.all(this.rows.map(t=>this.schema.filter(t,{session:s})));let t=[];this.affected=await e.insert(this,e=>t.push(this.schema.attach(e))),this.rows=t}else{if(i){let t=!0;await this.schema.filter(this.sets,{session:s,partial:t})}this.affected=await e.update(this)}}async drop(){const t=await this.session.acquire(this.connection);return await t.drop(this)}async truncate(){const t=await this.session.acquire(this.connection);return await t.truncate(this)}async all(){let t=[];const e=await this.session.acquire(this.connection);return await e.load(this,e=>t.push(this.schema.attach(e))),t}async count(t=!1){const e=await this.session.acquire(this.connection);if("function"!=typeof e.count)throw new Error("Connection does not implement method count");return e.count(this,t)}async single(){let[t]=await this.limit(1).all();return t}getInsertedRows(){return this.rows}}},function(t,e,s){let i={};t.exports=class{static get(t){let e=typeof t,r=new Error(`Unimplemented get filter by ${e}`),n="",o=[];switch(e){case"string":t=t.split(":"),[n,...o]=t,o=o.join(":").split(",");break;case"object":if(!Array.isArray(t))throw r;e="array",[n,...o]=t;break;case"function":return t;default:throw r}if(n in i==0)try{i[n]=s(46)("./"+n)}catch(r){i[n]=null}if(!i[n]){let s="unknown";try{s=JSON.stringify(t)}catch(r){}throw new Error(`Filter ${n} not found <${e}(${s})>`)}return i[n](...o)}static put(t,e){i[t]=e}static reset(){i={}}}},function(t,e){t.exports=function(t){return async function(e=null,{session:s,field:{name:i}}){if(null===e)return e;let r=new Error(`Field ${i} values must be ${t}`);if(!Array.isArray(e))throw r;try{let n=s.getSchema(t);await Promise.all(e.map(t=>n.filter(t,{session:s}))),e=e.map(t=>n.attach(t))}catch(r){throw console.error(`Caught error at nested model, ${r.stack}`),new Error(`Field ${i} must be compatible to '${t}'`)}return e}}},function(t,e){t.exports=function(t){return function(e=null){return null===e?t:e}}},function(t,e){t.exports=function(){return function(t=null,{field:{name:e}}){if(null===t)return t;t=t.toLowerCase();let s=new Error(`Field ${e} must be valid email`);const i=t.split("@");if(2!==i.length)throw s;const r=i.pop();let n=i.join("@");if("gmail.com"!==r&&"googlemail.com"!==r||(n=n.replace(/\./g,"").toLowerCase()),n.length>64||r.length>256)throw s;return t}}},function(t,e){t.exports=function(...t){return function(e=null,{field:{name:s}}){if(null===e)return e;if(-1===t.indexOf(e))throw new Error(`Field ${s} out of enum range`);return e}}},function(t,e){t.exports=function(t,e="id"){return async function(s,{session:i,field:{name:r}}){let n={};if(n[e]=s,!await i.factory(t,n).single())throw new Error(`Field ${r} must be exists`);return s}}},function(t,e){t.exports=function(){return function(t,{field:{name:e}}){if(!t||Array.isArray(t)&&t.length)throw new Error(`Field ${e} must not empty`);return t}}},function(t,e){t.exports=function(){return function(t=null,{field:{name:e="unknown"}}){if(null===t||""===t)throw new Error(`Field ${e} is required`);return t}}},function(t,e){t.exports=function(t,e){return function(s=null,{session:i,row:r,field:{name:n="unknown"}}){if(r[t]===e&&null===s)throw new Error(`Field ${n} is required`);return s}}},function(t,e){t.exports=function(t){return async function(e,{row:s,session:i,field:{name:r}}){let n={};n[r]=e;let o=await i.factory(t,n).single();if(o&&o.id!==s.id)throw new Error(`Field ${r} already exists`);return e}}},function(t,e,s){const i=s(27),r=s(16),n=s(1),o=s(8),a=s(14),c=s(13),h=s(47),l={Manager:i,Connection:n,Model:a,Pool:o,Query:s(15),Filter:r,Schema:c,schemas:h};"undefined"!=typeof window&&(window.norm=l),t.exports=l},function(t,e,s){const i=s(8),r=s(44);class n{static adapter(t){if("function"==typeof t)return t;throw new Error("Adapter must be a constructor")}constructor({connections:t=[]}={}){this.pools={},this.main="",t.forEach(t=>this.putPool(t))}putPool(t){t.adapter=n.adapter(t.adapter);let e=new i(t);return this.pools[e.name]=e,this.main=t.main?e.name:this.main||e.name,this}getPool(t){if(""===this.main&&this.putPool({}),t=`${t||this.main}`,!this.pools[t])throw new Error(`Pool '${t}' not found`);return this.pools[t]}async runSession(t,e){const s=this.openSession(e);try{const e=await t(s);return await s.close(),await s.dispose(),e}catch(t){throw await s.dispose(),t}}openSession(t){return new r({manager:this})}}t.exports=n},function(t,e,s){const i=s(29),r=s(7),n=s(12),o=s(9);t.exports={Pool:i,Deque:r,PriorityQueue:n,DefaultEvictor:o,createPool:function(t,e){return new i(o,r,n,t,e)}}},function(t,e,s){"use strict";const i=s(30).EventEmitter,r=s(31),n=s(32),o=s(34),a=s(36),c=s(37),h=(s(9),s(7),s(6)),l=(s(12),s(11),s(41).reflector),u="factoryCreateError",f="factoryDestroyError";t.exports=class extends i{constructor(t,e,s,i,o){super(),r(i),this._config=new n(o),this._Promise=this._config.Promise,this._factory=i,this._draining=!1,this._started=!1,this._waitingClientsQueue=new s(this._config.priorityRange),this._factoryCreateOperations=new Set,this._factoryDestroyOperations=new Set,this._availableObjects=new e,this._testOnBorrowResources=new Set,this._testOnReturnResources=new Set,this._validationOperations=new Set,this._allObjects=new Set,this._resourceLoans=new Map,this._evictionIterator=this._availableObjects.iterator(),this._evictor=new t,this._scheduledEviction=null,!0===this._config.autostart&&this.start()}_destroy(t){t.invalidate(),this._allObjects.delete(t);const e=this._factory.destroy(t.obj),s=this._Promise.resolve(e);this._trackOperation(s,this._factoryDestroyOperations).catch(t=>{this.emit(f,t)}),this._ensureMinimum()}_testOnBorrow(){if(this._availableObjects.length<1)return!1;const t=this._availableObjects.shift();t.test(),this._testOnBorrowResources.add(t);const e=this._factory.validate(t.obj),s=this._Promise.resolve(e);return this._trackOperation(s,this._validationOperations).then(e=>{if(this._testOnBorrowResources.delete(t),!1===e)return t.invalidate(),this._destroy(t),void this._dispense();this._dispatchPooledResourceToNextWaitingClient(t)}),!0}_dispatchResource(){if(this._availableObjects.length<1)return!1;const t=this._availableObjects.shift();return this._dispatchPooledResourceToNextWaitingClient(t),!1}_dispense(){const t=this._waitingClientsQueue.length;if(t<1)return;const e=t-this._potentiallyAllocableResourceCount,s=Math.min(this.spareResourceCapacity,e);for(let t=0;s>t;t++)this._createResource();if(!0===this._config.testOnBorrow){const e=t-this._testOnBorrowResources.size,s=Math.min(this._availableObjects.length,e);for(let t=0;s>t;t++)this._testOnBorrow()}if(!1===this._config.testOnBorrow){const e=Math.min(this._availableObjects.length,t);for(let t=0;e>t;t++)this._dispatchResource()}}_dispatchPooledResourceToNextWaitingClient(t){const e=this._waitingClientsQueue.dequeue();if(void 0===e||e.state!==h.PENDING)return this._addPooledResourceToAvailableObjects(t),!1;const s=new a(t,this._Promise);return this._resourceLoans.set(t.obj,s),t.allocate(),e.resolve(t.obj),!0}_trackOperation(t,e){return e.add(t),t.then(s=>(e.delete(t),this._Promise.resolve(s)),s=>(e.delete(t),this._Promise.reject(s)))}_createResource(){const t=this._factory.create(),e=this._Promise.resolve(t);this._trackOperation(e,this._factoryCreateOperations).then(t=>(this._handleNewResource(t),null)).catch(t=>{this.emit(u,t),this._dispense()})}_handleNewResource(t){const e=new c(t);this._allObjects.add(e),this._dispatchPooledResourceToNextWaitingClient(e)}_ensureMinimum(){if(!0===this._draining)return;const t=this._config.min-this._count;for(let e=0;e<t;e++)this._createResource()}_evict(){const t=Math.min(this._config.numTestsPerEvictionRun,this._availableObjects.length),e={softIdleTimeoutMillis:this._config.softIdleTimeoutMillis,idleTimeoutMillis:this._config.idleTimeoutMillis,min:this._config.min};for(let s=0;s<t;){const t=this._evictionIterator.next();if(!0===t.done&&this._availableObjects.length<1)return void this._evictionIterator.reset();if(!0===t.done&&this._availableObjects.length>0){this._evictionIterator.reset();break}const i=t.value,r=this._evictor.evict(e,i,this._availableObjects.length);s++,!0===r&&(this._evictionIterator.remove(),this._destroy(i))}}_scheduleEvictorRun(){this._config.evictionRunIntervalMillis>0&&(this._scheduledEviction=setTimeout(()=>{this._evict(),this._scheduleEvictorRun()},this._config.evictionRunIntervalMillis))}_descheduleEvictorRun(){this._scheduledEviction&&clearTimeout(this._scheduledEviction),this._scheduledEviction=null}start(){!0!==this._draining&&!0!==this._started&&(this._started=!0,this._scheduleEvictorRun(),this._ensureMinimum())}acquire(t){if(!1===this._started&&!1===this._config.autostart&&this.start(),this._draining)return this._Promise.reject(new Error("pool is draining and cannot accept work"));if(void 0!==this._config.maxWaitingClients&&this._waitingClientsQueue.length>=this._config.maxWaitingClients)return this._Promise.reject(new Error("max waitingClients count exceeded"));const e=new o(this._config.acquireTimeoutMillis,this._Promise);return this._waitingClientsQueue.enqueue(e,t),this._dispense(),e.promise}use(t){return this.acquire().then(e=>t(e).then(t=>(this.release(e),t),t=>{throw this.release(e),t}))}isBorrowedResource(t){return void 0!==this._resourceLoans.get(t)}release(t){const e=this._resourceLoans.get(t);if(void 0===e)return this._Promise.reject(new Error("Resource not currently part of this pool"));this._resourceLoans.delete(t),e.resolve();const s=e.pooledResource;return s.deallocate(),this._addPooledResourceToAvailableObjects(s),this._dispense(),this._Promise.resolve()}destroy(t){const e=this._resourceLoans.get(t);if(void 0===e)return this._Promise.reject(new Error("Resource not currently part of this pool"));this._resourceLoans.delete(t),e.resolve();const s=e.pooledResource;return s.deallocate(),this._destroy(s),this._dispense(),this._Promise.resolve()}_addPooledResourceToAvailableObjects(t){t.idle(),!0===this._config.fifo?this._availableObjects.push(t):this._availableObjects.unshift(t)}drain(){return this._draining=!0,this.__allResourceRequestsSettled().then(()=>this.__allResourcesReturned()).then(()=>{this._descheduleEvictorRun()})}__allResourceRequestsSettled(){return this._waitingClientsQueue.length>0?l(this._waitingClientsQueue.tail.promise):this._Promise.resolve()}__allResourcesReturned(){const t=Array.from(this._resourceLoans.values()).map(t=>t.promise).map(l);return this._Promise.all(t)}clear(){const t=Array.from(this._factoryCreateOperations).map(l);return this._Promise.all(t).then(()=>{for(const t of this._availableObjects)this._destroy(t);const t=Array.from(this._factoryDestroyOperations).map(l);return this._Promise.all(t)})}get _potentiallyAllocableResourceCount(){return this._availableObjects.length+this._testOnBorrowResources.size+this._testOnReturnResources.size+this._factoryCreateOperations.size}get _count(){return this._allObjects.size+this._factoryCreateOperations.size}get spareResourceCapacity(){return this._config.max-(this._allObjects.size+this._factoryCreateOperations.size)}get size(){return this._count}get available(){return this._availableObjects.length}get borrowed(){return this._resourceLoans.size}get pending(){return this._waitingClientsQueue.length}get max(){return this._config.max}get min(){return this._config.min}}},function(t,e){function s(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function i(t){return"function"==typeof t}function r(t){return"object"==typeof t&&null!==t}function n(t){return void 0===t}t.exports=s,s.EventEmitter=s,s.prototype._events=void 0,s.prototype._maxListeners=void 0,s.defaultMaxListeners=10,s.prototype.setMaxListeners=function(t){if(!function(t){return"number"==typeof t}(t)||t<0||isNaN(t))throw TypeError("n must be a positive number");return this._maxListeners=t,this},s.prototype.emit=function(t){var e,s,o,a,c,h;if(this._events||(this._events={}),"error"===t&&(!this._events.error||r(this._events.error)&&!this._events.error.length)){if((e=arguments[1])instanceof Error)throw e;var l=new Error('Uncaught, unspecified "error" event. ('+e+")");throw l.context=e,l}if(n(s=this._events[t]))return!1;if(i(s))switch(arguments.length){case 1:s.call(this);break;case 2:s.call(this,arguments[1]);break;case 3:s.call(this,arguments[1],arguments[2]);break;default:a=Array.prototype.slice.call(arguments,1),s.apply(this,a)}else if(r(s))for(a=Array.prototype.slice.call(arguments,1),o=(h=s.slice()).length,c=0;c<o;c++)h[c].apply(this,a);return!0},s.prototype.addListener=function(t,e){var o;if(!i(e))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",t,i(e.listener)?e.listener:e),this._events[t]?r(this._events[t])?this._events[t].push(e):this._events[t]=[this._events[t],e]:this._events[t]=e,r(this._events[t])&&!this._events[t].warned&&(o=n(this._maxListeners)?s.defaultMaxListeners:this._maxListeners)&&o>0&&this._events[t].length>o&&(this._events[t].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[t].length),"function"==typeof console.trace&&console.trace()),this},s.prototype.on=s.prototype.addListener,s.prototype.once=function(t,e){if(!i(e))throw TypeError("listener must be a function");var s=!1;function r(){this.removeListener(t,r),s||(s=!0,e.apply(this,arguments))}return r.listener=e,this.on(t,r),this},s.prototype.removeListener=function(t,e){var s,n,o,a;if(!i(e))throw TypeError("listener must be a function");if(!this._events||!this._events[t])return this;if(o=(s=this._events[t]).length,n=-1,s===e||i(s.listener)&&s.listener===e)delete this._events[t],this._events.removeListener&&this.emit("removeListener",t,e);else if(r(s)){for(a=o;a-- >0;)if(s[a]===e||s[a].listener&&s[a].listener===e){n=a;break}if(n<0)return this;1===s.length?(s.length=0,delete this._events[t]):s.splice(n,1),this._events.removeListener&&this.emit("removeListener",t,e)}return this},s.prototype.removeAllListeners=function(t){var e,s;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[t]&&delete this._events[t],this;if(0===arguments.length){for(e in this._events)"removeListener"!==e&&this.removeAllListeners(e);return this.removeAllListeners("removeListener"),this._events={},this}if(i(s=this._events[t]))this.removeListener(t,s);else if(s)for(;s.length;)this.removeListener(t,s[s.length-1]);return delete this._events[t],this},s.prototype.listeners=function(t){return this._events&&this._events[t]?i(this._events[t])?[this._events[t]]:this._events[t].slice():[]},s.prototype.listenerCount=function(t){if(this._events){var e=this._events[t];if(i(e))return 1;if(e)return e.length}return 0},s.listenerCount=function(t,e){return t.listenerCount(e)}},function(t,e){t.exports=function(t){if("function"!=typeof t.create)throw new TypeError("factory.create must be a function");if("function"!=typeof t.destroy)throw new TypeError("factory.destroy must be a function");if(void 0!==t.validate&&"function"!=typeof t.validate)throw new TypeError("factory.validate must be a function")}},function(t,e,s){"use strict";const i=s(33);t.exports=class{constructor(t){const e=new i;t=t||{},this.fifo="boolean"==typeof t.fifo?t.fifo:e.fifo,this.priorityRange=t.priorityRange||e.priorityRange,this.testOnBorrow="boolean"==typeof t.testOnBorrow?t.testOnBorrow:e.testOnBorrow,this.testOnReturn="boolean"==typeof t.testOnReturn?t.testOnReturn:e.testOnReturn,this.autostart="boolean"==typeof t.autostart?t.autostart:e.autostart,t.acquireTimeoutMillis&&(this.acquireTimeoutMillis=parseInt(t.acquireTimeoutMillis,10)),t.maxWaitingClients&&(this.maxWaitingClients=parseInt(t.maxWaitingClients,10)),this.max=parseInt(t.max,10),this.min=parseInt(t.min,10),this.max=Math.max(isNaN(this.max)?1:this.max,1),this.min=Math.min(isNaN(this.min)?0:this.min,this.max),this.evictionRunIntervalMillis=t.evictionRunIntervalMillis||e.evictionRunIntervalMillis,this.numTestsPerEvictionRun=t.numTestsPerEvictionRun||e.numTestsPerEvictionRun,this.softIdleTimeoutMillis=t.softIdleTimeoutMillis||e.softIdleTimeoutMillis,this.idleTimeoutMillis=t.idleTimeoutMillis||e.idleTimeoutMillis,this.Promise=null!=t.Promise?t.Promise:e.Promise}}},function(t,e,s){"use strict";t.exports=class{constructor(){this.fifo=!0,this.priorityRange=1,this.testOnBorrow=!1,this.testOnReturn=!1,this.autostart=!0,this.evictionRunIntervalMillis=0,this.numTestsPerEvictionRun=3,this.softIdleTimeoutMillis=-1,this.idleTimeoutMillis=3e4,this.acquireTimeoutMillis=null,this.maxWaitingClients=null,this.min=null,this.max=null,this.Promise=Promise}}},function(t,e,s){"use strict";const i=s(6),r=s(35);class n extends i{constructor(t,e){super(e),this._creationTimestamp=Date.now(),this._timeout=null,void 0!==t&&this.setTimeout(t)}setTimeout(t){if(this._state!==n.PENDING)return;const e=parseInt(t,10);if(isNaN(e)||e<=0)throw new Error("delay must be a positive int");const s=Date.now()-this._creationTimestamp;this._timeout&&this.removeTimeout(),this._timeout=setTimeout(function(t,e){return function(){return t.apply(e,arguments)}}(this._fireTimeout,this),Math.max(e-s,0))}removeTimeout(){this._timeout&&clearTimeout(this._timeout),this._timeout=null}_fireTimeout(){this.reject(new r.TimeoutError("ResourceRequest timed out"))}reject(t){this.removeTimeout(),super.reject(t)}resolve(t){this.removeTimeout(),super.resolve(t)}}t.exports=n},function(t,e,s){"use strict";class i extends Error{constructor(t){super(t),this.name=this.constructor.name,this.message=t,"function"==typeof Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error(t).stack}}t.exports={TimeoutError:class extends i{constructor(t){super(t)}}}},function(t,e,s){"use strict";const i=s(6);t.exports=class extends i{constructor(t,e){super(e),this._creationTimestamp=Date.now(),this.pooledResource=t}reject(){}}},function(t,e,s){"use strict";const i=s(38);t.exports=class{constructor(t){this.creationTime=Date.now(),this.lastReturnTime=null,this.lastBorrowTime=null,this.lastIdleTime=null,this.obj=t,this.state=i.IDLE}allocate(){this.lastBorrowTime=Date.now(),this.state=i.ALLOCATED}deallocate(){this.lastReturnTime=Date.now(),this.state=i.IDLE}invalidate(){this.state=i.INVALID}test(){this.state=i.VALIDATION}idle(){this.lastIdleTime=Date.now(),this.state=i.IDLE}returning(){this.state=i.RETURNING}}},function(t,e,s){"use strict";t.exports={ALLOCATED:"ALLOCATED",IDLE:"IDLE",INVALID:"INVALID",RETURNING:"RETURNING",VALIDATION:"VALIDATION"}},function(t,e,s){"use strict";t.exports=class{constructor(t,e){this._list=t,this._direction=!0===e?"prev":"next",this._startPosition=!0===e?"tail":"head",this._started=!1,this._cursor=null,this._done=!1}_start(){this._cursor=this._list[this._startPosition],this._started=!0}_advanceCursor(){if(!1===this._started)return this._started=!0,void(this._cursor=this._list[this._startPosition]);this._cursor=this._cursor[this._direction]}reset(){this._done=!1,this._started=!1,this._cursor=null}remove(){if(!1===this._started||!0===this._done||this._isCursorDetached())return!1;this._list.remove(this._cursor)}next(){return!0===this._done?{done:!0}:(this._advanceCursor(),null===this._cursor||this._isCursorDetached()?(this._done=!0,{done:!0}):{value:this._cursor,done:!1})}_isCursorDetached(){return null===this._cursor.prev&&null===this._cursor.next&&this._list.tail!==this._cursor&&this._list.head!==this._cursor}}},function(t,e,s){"use strict";const i=s(10),r=s(7);t.exports=class extends r{push(t){const e=i.createNode(t);t.promise.catch(this._createTimeoutRejectionHandler(e)),this._list.insertEnd(e)}_createTimeoutRejectionHandler(t){return e=>{"TimeoutError"===e.name&&this._list.remove(t)}}}},function(t,e,s){"use strict";function i(){}e.reflector=function(t){return t.then(i,i)}},function(t,e){t.exports=class extends Error{constructor(){super(),this.status=400,this.children=[]}get message(){return this.children.map(t=>t.message).join(", ")}add(t){this.children.push(t)}empty(){return 0===this.children.length}}},function(t,e,s){"use strict";t.exports=function(t){if(!Array.isArray(t))throw new TypeError("Middleware stack must be an array!");for(const e of t)if("function"!=typeof e)throw new TypeError("Middleware must be composed of functions!");return function(e,s){let i=-1;return function r(n){if(n<=i)return Promise.reject(new Error("next() called multiple times"));i=n;let o=t[n];n===t.length&&(o=s);if(!o)return Promise.resolve();try{return Promise.resolve(o(e,r.bind(null,n+1)))}catch(t){return Promise.reject(t)}}(0)}}},function(t,e,s){const i=s(15),r=new(s(45));let n=0;t.exports=class{constructor({manager:t}){this.id=`session-${n++}`,this.manager=t,this.connections={}}factory(t,e){return new i({session:this,schema:t,criteria:e})}async acquire(t){let e=this.manager.getPool(t);if(!this.connections[e.name]){let t=`${this.id}-${e.name}`;this.connections[e.name]=await r.singleton(t,()=>e.acquire()),await this.connections[e.name].begin()}return this.connections[e.name]}async dispose(){await this.rollback(),await Promise.all(Object.keys(this.connections).map(t=>this.manager.getPool(t).release(this.connections[t]))),this.connections={}}close(){return this.commit()}async commit(){await Promise.all(Object.keys(this.connections).map(async t=>{let e=this.connections[t];await e.commit()}))}async rollback(){await Promise.all(Object.keys(this.connections).map(async t=>{let e=this.connections[t];await e.rollback()}))}async begin(){await Promise.all(Object.keys(this.connections).map(async t=>{let e=this.connections[t];await e.begin()}))}async flush(){await this.commit(),await this.begin()}parseSchema(t){let e,s;if(Array.isArray(t)){if(t.length<2)throw new Error("Malformed schema name tupple");[e,s]=t}else-1!==t.indexOf(".")?[e,s]=t.split("."):(e=this.manager.getPool().name,s=t);let i=this.manager.getPool(e);return[i.name,i.getSchema(s)]}}},function(t,e){class s{constructor(t){this.fn=t,this.locks=[],this.done=!1}async fetch(){if(this.done||await new Promise(async(t,e)=>{if(this.locks.push([t,e]),!(this.locks.length>1)){try{let{fn:t}=this;this.value=await t()}catch(t){this.error=t}this.done=!0,this.locks.splice(0).forEach(([t,e])=>{this.error?e(this.error):t(this.value)})}}),this.error)throw this.error;return this.value}}t.exports=class{constructor(){this.spaces=new Map}async singleton(t,e){let i;return e=e||t,this.spaces.has(t)?i=this.spaces.get(t):(i=new s(e),this.spaces.set(t,i)),i.fetch()}}},function(t,e,s){var i={"./are":17,"./are.js":17,"./default":18,"./default.js":18,"./email":19,"./email.js":19,"./enum":20,"./enum.js":20,"./exists":21,"./exists.js":21,"./notEmpty":22,"./notEmpty.js":22,"./required":23,"./required.js":23,"./requiredIf":24,"./requiredIf.js":24,"./unique":25,"./unique.js":25};function r(t){var e=n(t);return s(e)}function n(t){var e=i[t];if(!(e+1)){var s=new Error("Cannot find module '"+t+"'");throw s.code="MODULE_NOT_FOUND",s}return e}r.keys=function(){return Object.keys(i)},r.resolve=n,t.exports=r,r.id=46},function(t,e,s){t.exports={NBoolean:s(48),NDatetime:s(49),NDouble:s(50),NField:s(0),NInteger:s(51),NReference:s(52),NString:s(53)}},function(t,e,s){const i=s(0);t.exports=class extends i{attach(t){return"false"!==t&&"0"!==t&&""!==t&&Boolean(t)}}},function(t,e,s){const i=s(0);t.exports=class extends i{attach(t){let e=new Date(t);if(!isNaN(e.getTime()))return e}}},function(t,e,s){const i=s(0);t.exports=class extends i{attach(t){return parseFloat(t)}}},function(t,e,s){const i=s(0);t.exports=class extends i{attach(t){return parseInt(t,10)}}},function(t,e,s){const i=s(0);t.exports=class extends i{to(t){return this.to=t,this}}},function(t,e,s){const i=s(0);t.exports=class extends i{}}]);
//# sourceMappingURL=norm.min.js.map